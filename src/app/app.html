<div class="page">
  <header class="topbar">
    <div class="brand">
      <span class="badge">Arbitro Karate</span>
      <div class="subtitle">Examen V/F · 20 preguntas</div>
    </div>
    <div class="status">
      @if (mode() === 'exam') {
        <span class="status-pill">Pregunta {{ currentIndex() + 1 }} / {{ totalQuestions }}</span>
        <span class="status-pill soft">Respondidas {{ answeredCount() }}</span>
      }
      @if (mode() === 'result') {
        <span class="status-pill success">Aciertos {{ score() }} / {{ totalQuestions }}</span>
      }
    </div>
  </header>

  <main class="stage">
    @if (mode() === 'setup') {
      <section class="panel hero">
        <div class="hero-text">
          <p class="eyebrow">Entrenamiento para árbitros</p>
          <h1>Examen dinámico de verdadero o falso</h1>
          <p class="lead">
            Selecciona las áreas que quieres practicar. Cada examen genera 20
            preguntas aleatorias y puedes navegar hacia delante o atrás.
          </p>
        </div>
        <div class="toggle-grid">
          @for (option of categoryOptions(); track option.key) {
            <button
              class="toggle-card"
              [class.active]="option.enabled"
              (click)="toggleCategory(option.key)"
            >
              <span class="toggle-title">{{ option.label }}</span>
              <span class="toggle-hint">{{ option.hint }}</span>
              <span class="toggle-state">
                {{ option.enabled ? 'Incluido' : 'Excluido' }}
              </span>
            </button>
          }
        </div>
        <div class="setup-foot">
          <div class="info-box">
            <span>20 preguntas aleatorias en cada inicio</span>
            <span>Respuesta rápida con swipe automático</span>
            <span>Banco editable en `src/assets/examen_wkf_2026.json`</span>
          </div>
          <div class="actions">
            <button class="primary" [disabled]="!canStart()" (click)="startExam()">
              Comenzar examen
            </button>
            @if (!canStart()) {
              <span class="muted">
                Activa categorías con al menos 20 preguntas disponibles.
              </span>
            }
          </div>
        </div>
      </section>
    } @else if (mode() === 'exam') {
      <section class="panel exam">
        @if (currentQuestion(); as question) {
          <div class="progress">
            <span class="progress-main">Pregunta {{ currentIndex() + 1 }} / {{ totalQuestions }}</span>
            <span class="progress-sub">Respondidas {{ answeredCount() }} / {{ totalQuestions }}</span>
          </div>
          <article
            class="card"
            [class.swipe-left]="isAnimating() && swipeDirection() === 'left'"
            [class.swipe-right]="isAnimating() && swipeDirection() === 'right'"
            [class.enter-left]="enterDirection() === 'left'"
            [class.enter-right]="enterDirection() === 'right'"
          >
            <span class="chip">{{ question.category | titlecase }}</span>
            <h2>{{ question.text }}</h2>
          </article>
          <div class="answer-row">
            <button
              class="answer"
              [class.selected]="answers()[question.id] === true"
              (click)="answerCurrent(true)"
            >
              Verdadero
            </button>
            <button
              class="answer alt"
              [class.selected]="answers()[question.id] === false"
              (click)="answerCurrent(false)"
            >
              Falso
            </button>
          </div>
          <div class="nav-row">
            <button class="ghost" [disabled]="currentIndex() === 0" (click)="previousQuestion()">
              Anterior
            </button>
            <button
              class="ghost"
              [disabled]="currentIndex() === totalQuestions - 1"
              (click)="nextQuestion()"
            >
              Siguiente
            </button>
            <button class="outline" (click)="finishExam()">Finalizar examen</button>
          </div>
        }
      </section>
    } @else {
      <section class="panel result">
        <div class="result-head">
          <h2>Resultado final</h2>
          <p>Has completado el examen. Revisa tus fallos y repite cuando quieras.</p>
        </div>
        <div class="result-grid">
          <div class="score-card">
            <div class="score-value">{{ score() }}</div>
            <div class="score-label">Aciertos</div>
            <div class="score-sub">
              Fallos: {{ totalQuestions - score() }}
            </div>
          </div>
          <div class="wrong-list">
            <h3>Preguntas falladas</h3>
            @if (wrongItems().length === 0) {
              <div class="empty">
                ¡Perfecto! No hay fallos en este intento.
              </div>
            } @else {
              @for (item of wrongItems(); track item.question.id) {
                <div class="wrong-item">
                  <div class="wrong-question">{{ item.question.text }}</div>
                  <div class="wrong-meta">
                    Tu respuesta: {{ answerLabel(item.userAnswer) }} · Correcta:
                    {{ answerLabel(item.question.answer) }}
                  </div>
                  <div class="wrong-explain">{{ item.question.explanation }}</div>
                </div>
              }
            }
          </div>
        </div>
        <div class="actions">
          <button class="ghost" (click)="restartExam()">Volver a configuración</button>
          <button class="primary" (click)="startExam()">Nuevo examen aleatorio</button>
        </div>
      </section>
    }
  </main>
</div>
